// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

enum Role {
  ADMIN
  BUSINESS
  WAITER
  CLIENT
}

enum Tier {
  BASIC
  STANDARD
  PREMIUM
}

enum RewardType {
  FREE_ITEM
  DISCOUNT
  CUSTOM
}

// 2.1 Users
model User {
  id            String    @id @default(cuid())
  role          Role      @default(CLIENT)
  username      String?   @unique
  email         String    @unique
  passwordHash  String
  createdAt     DateTime  @default(now())

  // Relations
  businessOwned Business? @relation("OwnerBusiness")

  // For Waiters
  employerId    String?
  employer      Business? @relation("StaffBusiness", fields: [employerId], references: [id])

  salesProcessed Purchase[]
  clientProfile  Client?
}

// 2.2 Business
model Business {
  id                 String   @id @default(cuid())
  name               String
  tier               Tier     @default(BASIC)
  subscriptionStatus String   @default("active")
  createdAt          DateTime @default(now())

  ownerId            String   @unique
  owner              User     @relation("OwnerBusiness", fields: [ownerId], references: [id])

  staff              User[]   @relation("StaffBusiness")
  loyaltyPrograms    LoyaltyProgram[]
  products           Product[]
  purchases          Purchase[]

  pointsMultiplier   Float    @default(1.0)
  birthdayRewardPoints Int    @default(0) 

  redemptions        RedemptionTicket[]
}

// 2.3 Loyalty Programs
model LoyaltyProgram {
  id                String   @id @default(cuid())
  name              String
  rewardType        RewardType
  rewardValue       String
  pointsThreshold   Int
  calculationMethod String
  active            Boolean  @default(true)
  createdAt         DateTime @default(now())
  pointsPerCurrency Float    @default(1.0)

  businessId        String
  business          Business @relation(fields: [businessId], references: [id])

  clientProgress    ClientProgress[]
  redemptions       RedemptionTicket[]
}

// 2.4 Products
model Product {
  id         String   @id @default(cuid())
  name       String
  price      Decimal
  points     Int?
  createdAt  DateTime @default(now())

  businessId String
  business   Business @relation(fields: [businessId], references: [id])
}

// 2.5 Clients
model Client {
  id         String   @id @default(cuid())
  name       String
  email      String   @unique
  birthday           DateTime? 
  createdAt  DateTime @default(now())

  userId     String   @unique
  user       User     @relation(fields: [userId], references: [id])

  purchases  Purchase[]
  progress   ClientProgress[]
  redemptions RedemptionTicket[]
}

// 2.6 Purchases / QR Codes
model Purchase {
  id            String    @id @default(cuid())
  qrCode        String    @unique
  products      Json
  totalAmount   Decimal
  pointsAwarded Int
  redeemed      Boolean   @default(false)
  expiresAt     DateTime
  createdAt     DateTime  @default(now())

  businessId    String
  business      Business  @relation(fields: [businessId], references: [id])

  waiterId      String
  waiter        User      @relation(fields: [waiterId], references: [id])

  clientId      String?
  client        Client?   @relation(fields: [clientId], references: [id])
}

// 2.7 Client Progress
model ClientProgress {
  id                String   @id @default(cuid())
  pointsAccumulated Int      @default(0)
  rewardsRedeemed   Json     @default("[]")
  lastUpdated       DateTime @default(now())

  clientId          String
  client            Client   @relation(fields: [clientId], references: [id])

  programId         String
  program           LoyaltyProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([clientId, programId])
}

// 2.8 Redemption Tickets
model RedemptionTicket {
  id         String   @id @default(cuid())
  ticketId   String   @unique
  used       Boolean  @default(false)
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  clientId   String
  client     Client   @relation(fields: [clientId], references: [id])

  businessId String
  business   Business @relation(fields: [businessId], references: [id])

  programId  String
  program    LoyaltyProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
}
  